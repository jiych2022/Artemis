### Foodcoopshop 

- **Application**: Foodcoopshop <= 3.6.0 

- **Threat Impact**: Sensitive data leakage, File disclosure

- **Code**: From POST request, subarray `data` in array `data` is retrieved into `$productsData`. Then for each element in `data` subarray, the url of the `image` key is saved into `$products2saveForImage`, which is then passed into `changeImage` function. Finally in `changeImage` function, the url is retrieved from the array and used in sink `copy` 

  File: `plugins/Network/src/Controller/ApiController.php`

  ```
  public function updateProducts()
  {
    $productsData = $this->getRequest()->getData('data.data');
    ...
    $products2saveForImage = [];
    foreach ($productsData as $product) {
       ...
       $products2saveForImage[] = [
         $product['image']
       ];
    }
    ...
    $this->Product->changeImage($products2saveForImage);
  }
  ```

  File: `src/Model/Table/ProductsTable.php`

  ```
  public function changeImage($products) {
    foreach ($products as $product) {
  	$productId = key($product);
  	$imageFromRemoteServer = $product[$productId];
  	...
  	$remoteFileName = preg_replace('/-home_default/', $options['suffix'], $imageFromRemoteServer);
  	copy($remoteFileName, $thumbsFileName);
  }
  ```

- **POC**:
  1. Listen on 8080 on server side
  1. Send a post request to /api/updateProducts.json, with data `data[data][0][remoteProductId]=352&data[data][0][image]=http://localhost:8000/`
  1. Receive a request on server side. 
  1. The image validity check can be bypassed by using a custom server that returns 200 on HEAD requests, then return a valid image on first GET request and then a 302 redirect to final target on second GET request
